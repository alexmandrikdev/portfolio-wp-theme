name: Release Build

on:
    push:
        tags:
            - 'v*.*.*'

permissions:
    contents: write

jobs:
    build-release:
        name: Build Release Asset
        runs-on: ubuntu-24.04

        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: mbstring, xml, curl, json, intl

            - name: Install Node.js dependencies
              run: npm ci

            - name: Install Composer dependencies (production only)
              run: composer install --no-dev --no-interaction --prefer-dist

            - name: Build theme for production
              run: npm run build

            - name: Replace version placeholders
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "Replacing version placeholders with: $VERSION"
                  sed -i "s/__VERSION__/$VERSION/g" style.css
                  echo "Version replacement completed"

            - name: Create compressed release asset
              id: create_release_asset
              run: |
                  VERSION_TAG=${GITHUB_REF#refs/tags/v}
                  RELEASE_NAME="portfolio-v${VERSION_TAG}.tar.gz"

                  mkdir -p portfolio

                  cp -r assets/ portfolio/
                  cp -r build/ portfolio/
                  cp -r inc/ portfolio/
                  cp -r patterns/ portfolio/
                  cp -r templates/ portfolio/
                  cp -r vendor/ portfolio/
                  cp functions.php portfolio/
                  cp screenshot.png portfolio/
                  cp style.css portfolio/
                  cp theme.json portfolio/
                  cp wpml-config.xml portfolio/

                  tar -czf ${RELEASE_NAME} portfolio/
                  echo "release_name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
                  echo "Compressed release asset created: ${RELEASE_NAME}"

            - name: Upload release asset
              uses: softprops/action-gh-release@v2
              with:
                  files: ${{ steps.create_release_asset.outputs.release_name }}

            - name: Copy release asset to server
              uses: appleboy/scp-action@v1
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_KEY }}
                  source: '${{ steps.create_release_asset.outputs.release_name }}'
                  target: '/tmp/portfolio-themes'

            - name: Deploy theme
              uses: ./.github/actions/deploy-theme
              with:
                  release_name: ${{ steps.create_release_asset.outputs.release_name }}
                  server_host: ${{ secrets.SERVER_HOST }}
                  server_username: ${{ secrets.SERVER_USERNAME }}
                  server_key: ${{ secrets.SERVER_KEY }}
